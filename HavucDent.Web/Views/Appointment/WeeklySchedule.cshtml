@model IEnumerable<HavucDent.Domain.Entities.Appointment>
@{
	Layout = null;
	var currentWeekStart = ViewBag.StartDate != null ? (DateTime)ViewBag.StartDate : DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek + (int)DayOfWeek.Monday);
	var nextWeekStart = currentWeekStart.AddDays(7);
	var prevWeekStart = currentWeekStart.AddDays(-7);

	var dayAbbreviations = new Dictionary<DayOfWeek, string>
	{
		{ DayOfWeek.Monday, "Pzt" },
		{ DayOfWeek.Tuesday, "Sal" },
		{ DayOfWeek.Wednesday, "Çar" },
		{ DayOfWeek.Thursday, "Per" },
		{ DayOfWeek.Friday, "Cum" },
		{ DayOfWeek.Saturday, "Cmt" },
		{ DayOfWeek.Sunday, "Paz" }
	};
}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

<div class="container mt-5" style="max-width: 1800px;">
	<div class="d-flex justify-content-between align-items-center mb-3">
		<button class="btn btn-primary" id="prevWeek">
			<i class="fas fa-arrow-left"></i> Önceki Hafta
		</button>

		<h2 class="text-center mb-0">Haftalık Randevu Planı: @currentWeekStart.ToString("dd.MM.yyyy") - @nextWeekStart.AddDays(-1).ToString("dd.MM.yyyy")</h2>

		<button class="btn btn-primary" id="nextWeek">
			Sonraki Hafta <i class="fas fa-arrow-right"></i>
		</button>
	</div>

	<div class="d-flex justify-content-end mb-3">
		<div class="form-group">
			<label for="doctorSelect" class="mr-2 font-weight-bold">Doktor Seçin:</label>
			<select id="doctorSelect" class="form-control">
				<option value="1">Dr. Ali Veli</option>
				<option value="2">Dr. Bücür Ayşe</option>
			</select>
		</div>
	</div>

	<!-- Randevu Takvimi -->
	<div id="weeklySchedule" class="d-flex justify-content-between flex-wrap">
		@foreach (var day in Enumerable.Range(0, 7))
		{
			var date = currentWeekStart.AddDays(day);
			var dayAbbreviation = dayAbbreviations[date.DayOfWeek];
			<div class="day-schedule card shadow-sm mx-1 mb-4" style="width: 220px;">
				<div class="card-header bg-primary text-white text-center">
					<h5 class="mb-0">@date.ToString("dd.MM.yyyy") @dayAbbreviation</h5>
				</div>
				<div class="card-body appointment-slots">
					@for (var hour = 9; hour < 22; hour++)
					{
						<div class="d-flex justify-content-between mb-2">
							@for (var minute = 0; minute < 60; minute += 30)
							{
								var slotTime = date.AddHours(hour).AddMinutes(minute);
								var appointment = Model.FirstOrDefault(a => a.AppointmentDate == slotTime);
								var slotClass = appointment != null && !appointment.IsAvailable ? "booked" : "available";
								var slotText = appointment != null && !appointment.IsAvailable ? "Dolu" : "Boş";

								<div class="slot @slotClass text-center">
									<span class="time">@slotTime.ToString("HH:mm") - @slotTime.AddMinutes(30).ToString("HH:mm")</span>
									<span class="status d-block">@slotText</span>
								</div>
							}
						</div>
					}
				</div>
			</div>
		}
	</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.8/signalr.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

<script>
	const connection = new signalR.HubConnectionBuilder()
		.withUrl("/appointmentHub")
		.build();

	connection.on("ReceiveAppointmentsUpdate", () => {
		location.reload();
	});

	connection.start().catch(err => console.error(err.toString()));

	document.getElementById("doctorSelect").addEventListener("change", function () {
		const doctorId = this.value;
		window.location.href = `/Appointment/WeeklySchedule?doctorId=${doctorId}&startDate=${getFormattedDate()}`;
	});

	function changeWeek(startDate) {
		window.location.href = `/Appointment/WeeklySchedule?startDate=${startDate}`;
	}

	function getFormattedDate() {
		const date = new Date("@currentWeekStart.ToString("yyyy-MM-dd")");
		return date.toISOString().split('T')[0];
	}

	document.getElementById("prevWeek").addEventListener("click", function () {
		const currentStartDate = new Date(getFormattedDate());
		currentStartDate.setDate(currentStartDate.getDate() - 7);
		changeWeek(currentStartDate.toISOString().split('T')[0]);
	});

	document.getElementById("nextWeek").addEventListener("click", function () {
		const currentStartDate = new Date(getFormattedDate());
		currentStartDate.setDate(currentStartDate.getDate() + 7);
		changeWeek(currentStartDate.toISOString().split('T')[0]);
	});

</script>

<style>
	.container {
		max-width: 1800px;
	}

	.day-schedule {
		border-radius: 8px;
	}

	.appointment-slots {
		display: flex;
		flex-direction: column;
		gap: 4px;
	}

	.slot {
		padding: 6px;
		border-radius: 5px;
		text-align: center;
		font-size: 0.85em;
		font-weight: bold;
		width: 100px;
		margin: 2px;
	}

	.available {
		background-color: #28a745;
		color: white;
	}

	.booked {
		background-color: #dc3545;
		color: white;
	}

	.time {
		display: block;
		font-size: 0.85em;
		font-weight: normal;
	}

	.status {
		font-size: 0.75em;
		font-style: italic;
	}
</style>
